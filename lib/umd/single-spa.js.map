{"version":3,"file":"single-spa.js","sources":["../../src/applications/app.helpers.js","../../src/lifecycle/bootstrap.js","../../src/lifecycle/lifecycle.helpers.js","../../src/lifecycle/load.js","../../src/lifecycle/mount.js","../../src/lifecycle/unmount.js","../../src/start.js","../../src/navigation/reroute.js","../../src/applications/app.js"],"sourcesContent":["// import { handleAppError } from \"./app-errors.js\";\r\n\r\n// App statuses\r\nexport const NOT_LOADED = \"NOT_LOADED\";   // 应用初始状态\r\nexport const LOADING_SOURCE_CODE = \"LOADING_SOURCE_CODE\"; // 加载资源\r\nexport const NOT_BOOTSTRAPPED = \"NOT_BOOTSTRAPPED\"; // 还没有调用bootstrap方法\r\nexport const BOOTSTRAPPING = \"BOOTSTRAPPING\"; // bootstrap方法调用中\r\nexport const NOT_MOUNTED = \"NOT_MOUNTED\"; // 还没有调用mount方法\r\nexport const MOUNTING = \"MOUNTING\"; // mount方法调用中\r\nexport const MOUNTED = \"MOUNTED\";  // 已经调用mount方法\r\nexport const UPDATING = \"UPDATING\"; // 更新中\r\nexport const UNMOUNTING = \"UNMOUNTING\"; // 接触挂在\r\nexport const UNLOADING = \"UNLOADING\"; // 完全卸载中\r\nexport const LOAD_ERROR = \"LOAD_ERROR\"; // 加载错误\r\nexport const SKIP_BECAUSE_BROKEN = \"SKIP_BECAUSE_BROKEN\"; // 卸载中\r\n\r\n// 当前应用是否被激活\r\nexport function isActive(app) {\r\n  return app.status === MOUNTED;\r\n}\r\n\r\n// 当前这个应用是否要被激活\r\nexport function shouldBeActive(app) {\r\n  try {\r\n    // 如果返回true， 那么应用应该就开始初始化等一些列操作\r\n    return app.activeWhen(window.location)\r\n  } catch (error) {\r\n    console.log(\"error======>>>\", error)\r\n    return false\r\n  }\r\n\r\n}","import { BOOTSTRAPPING, NOT_BOOTSTRAPPED, NOT_MOUNTED } from \"../applications/app.helpers\";\r\n\r\nexport async function toBootstrapPromise(app) {\r\n    if (app.status !== NOT_BOOTSTRAPPED) {\r\n        return app;\r\n    }\r\n\r\n    app.status = BOOTSTRAPPING;\r\n    await app.bootstrap(app.customProps);\r\n    app.status = NOT_MOUNTED;\r\n    return app\r\n\r\n    // app.status = NOT_BOOTSTRAPPED;\r\n}","export function flattenFnArray(fns) {\r\n\r\n    fns = Array.isArray(fns) ? fns : [fns]\r\n\r\n    return function (props) {\r\n        return fns.reduce((p, fn) => p.then(() => fn(props)), Promise.resolve())\r\n    }\r\n}","import { flattenFnArray } from \"./lifecycle.helpers\";\r\nimport { LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED } from \"../applications/app.helpers\"\r\nexport async function toLoadPromise(app) {\r\n\r\n\r\n    if (app.loadPromise) {\r\n        return app.loadPromise\r\n    }\r\n\r\n    return app.loadPromise = Promise.resolve().then(async () => {\r\n        app.status = LOADING_SOURCE_CODE;\r\n        let { bootstrap, mount, unmount } = await app.loadApp(app.customProps)\r\n        app.status = NOT_BOOTSTRAPPED; // 没有调用bootstrap 方法\r\n        app.bootstrap = flattenFnArray(bootstrap);\r\n        app.mount = flattenFnArray(mount);\r\n        app.unmount = flattenFnArray(unmount);\r\n        delete app.loadPromise;\r\n        return app\r\n    })\r\n\r\n}\r\n\r\n","import { MOUNTED, MOUNTING, NOT_MOUNTED } from \"../applications/app.helpers\";\r\n\r\nexport async function toMountPromise(app) {\r\n    if (app.status !== NOT_MOUNTED) {\r\n        return app;\r\n    }\r\n\r\n    app.status = MOUNTING;\r\n    await app.mount(app.customProps);\r\n    app.status = MOUNTED;\r\n    return app\r\n}\r\n\r\n\r\n\r\n","import { MOUNTED, NOT_MOUNTED, UNMOUNTING } from \"../applications/app.helpers\";\r\n\r\nexport async function toUnmountPromise(app) {\r\n    if (app.status != MOUNTED) {\r\n        // 当前应用没有被挂载直接什么都不做\r\n        return app\r\n    }\r\n\r\n    app.status = UNMOUNTING;\r\n    await app.unmount(app.customProps);\r\n    app.status = NOT_MOUNTED\r\n    return app\r\n\r\n}","import { reroute } from \"./navigation/reroute\";\r\n\r\n\r\n\r\nlet started = false\r\n\r\nexport function start() {\r\n\r\n    started = true;\r\n    reroute() // 除了去加载应用还需要去挂载应用\r\n};\r\n\r\nexport function isStarted() {\r\n    return started\r\n}","import { getAppChanges } from \"../applications/app\";\r\nimport { LOADING_SOURCE_CODE } from \"../applications/app.helpers\";\r\nimport { toBootstrapPromise } from \"../lifecycle/bootstrap\";\r\nimport { toLoadPromise } from \"../lifecycle/load\";\r\nimport { toMountPromise } from \"../lifecycle/mount\";\r\nimport { toUnmountPromise } from \"../lifecycle/unmount\";\r\nimport { isStarted } from \"../start\";\r\n\r\n\r\n// 核心应用处理方法\r\nexport function reroute() {\r\n\r\n    // 需要获取要加载的应用\r\n    // 需要获取要被挂载的应用\r\n    // 哪些应用需要被卸载\r\n\r\n    const { appsToLoad, appsToMount, appsToUnload, appsToUnmount } = getAppChanges()\r\n\r\n    // console.log('====>', appsToLoad, appsToMount, appsToUnload, appsToUnmount);\r\n    // start 方法调用时候是同步的， 但是加载流程是异步的\r\n    if (isStarted()) {\r\n        // start() \r\n        // console.log(`%c======>${'调用start'}`, 'color: red;');\r\n        return performAppChanges() // 根据路径装载应用\r\n    } else {\r\n        // registerApplication\r\n        // console.log(`%c======>${'调用registerApplication'}`, 'color: red;');\r\n        return loadApps() // 预先加载应用\r\n    }\r\n\r\n\r\n    async function loadApps() {\r\n        // 预先加载应用  就是将子应用加载到window上\r\n        let apps = await Promise.all(appsToLoad.map(toLoadPromise)) // 就是获取到bootstrap, mount unmount 方法放到APP上\r\n\r\n    }\r\n\r\n\r\n    async function performAppChanges() {\r\n        // 根据路径装载应用\r\n        // 1. 先卸载不需要的应用\r\n        let unmountPromises = appsToUnmount.map(toUnmountPromise)\r\n        // 2. 再加载需要的应用\r\n        // 这个应用可能需要加载， 但是路径不匹配  加载app1的hi后，这个时候切换到了app2\r\n\r\n        appsToLoad.map(async (app) => {\r\n            // 将需要加载的应用拿到， 加载， 启动， 挂载\r\n            app = await toLoadPromise(app)\r\n            app = await toBootstrapPromise(app)\r\n            return toMountPromise(app)\r\n        })\r\n        appsToMount.map(async (app) => {\r\n            app = await toBootstrapPromise(app)\r\n            return toMountPromise(app)\r\n        })\r\n    }\r\n}\r\n\r\n","import {\r\n    NOT_LOADED,\r\n    isActive,\r\n    NOT_BOOTSTRAPPED,\r\n    NOT_MOUNTED,\r\n    MOUNTED,\r\n    LOAD_ERROR,\r\n    SKIP_BECAUSE_BROKEN,\r\n    LOADING_SOURCE_CODE,\r\n    shouldBeActive,\r\n} from \"./app.helpers\"\r\nimport { reroute } from \"../navigation/reroute.js\"\r\n/**\r\n * \r\n * @param {*} appName 应用名称\r\n * @param {*} loadApp 加载的应用 promise\r\n * @param {*} activeWhen 什么时候激活\r\n * @param {*} customProps 自定义属性\r\n */\r\n\r\n\r\nconst apps = [];\r\n// 维护应用所有的状态， 包括激活状态， 加载状态， 加载完成的状态， 一共12种状态\r\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\r\n    apps.push({\r\n        name: appName,\r\n        loadApp,\r\n        activeWhen,\r\n        customProps,\r\n        status: NOT_LOADED\r\n    })\r\n\r\n\r\n    reroute() // 加载应用\r\n\r\n\r\n    console.log(apps)\r\n\r\n};\r\n\r\n\r\nexport function getAppChanges() {\r\n    const appsToUnmount = [];\r\n    const appsToLoad = [];\r\n    const appsToMount = [];\r\n    const appsToUnload = []\r\n    const currentTime = new Date().getTime();\r\n    apps.forEach(app => {\r\n        // 检查每个子应用是否需要被加载\r\n        const appShouldBeActive = app.status !== SKIP_BECAUSE_BROKEN && shouldBeActive(app);\r\n        switch (app.status) {\r\n            // case LOAD_ERROR:\r\n            //     if (appShouldBeActive && currentTime - app.loadErrorTime >= 200) {\r\n            //         appsToLoad.push(app)\r\n            //     }\r\n            //     break\r\n            case NOT_LOADED:\r\n            case LOADING_SOURCE_CODE:\r\n                if (appShouldBeActive) {\r\n                    appsToLoad.push(app)\r\n                }\r\n                break;\r\n            case NOT_BOOTSTRAPPED:\r\n            case NOT_MOUNTED:\r\n                if (!appShouldBeActive) {\r\n                    appsToUnload.push(app)\r\n                } else if (appShouldBeActive) {\r\n                    appsToMount.push(app)\r\n                }\r\n                break;\r\n            case MOUNTED:\r\n                if (!appShouldBeActive) {\r\n                    appsToUnmount.push(app)\r\n                }\r\n                break;\r\n        }\r\n\r\n    })\r\n    return { appsToUnload, appsToUnmount, appsToLoad, appsToMount };\r\n\r\n}"],"names":[],"mappings":"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"}